<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PREPARICFES - {{ nombre_materia }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', path='css/preguntas_dinamicas.css')}}">
  
  <style>
    /* Colores din√°micos espec√≠ficos de la materia */
    .conten_nav {
      background-color: {{ color_materia }};
    }

    .pregunta-container {
      background-color: {{ color_materia }};
    }

    .boton_volver,
    .boton_finalizar,
    .boton_siguiente {
      background-color: {{ color_materia }};
    }

    .resultado-final h2 {
      color: {{ color_materia }};
    }

    .resultado-final .puntaje {
      color: {{ color_materia }};
    }

    .spinner-border {
      color: {{ color_materia }};
    }
  </style>
</head>

<body>
  <header class="conten_nav">
    <div class="conten_logo">
      <img class="nav-img" src="{{ url_for('static', path='Galeria/' + imagen_materia)}}" alt="{{ nombre_materia }}">
    </div>
    <div class="col_titulo">
      <h2>{{ nombre_materia }}</h2>
    </div>
  </header>

  <!-- Indicador de progreso -->
  <div id="progreso" class="progreso" style="display: none;">
    Pregunta <span id="progreso-actual">1</span> - <span id="progreso-siguiente">2</span> de <span id="progreso-total">6</span>
  </div>

  <!-- Contenedor de carga -->
  <div id="loading" class="loading">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p>Cargando preguntas...</p>
  </div>

  <!-- Contenedor principal de preguntas -->
  <main id="contenedor-preguntas" class="contenedor" style="display: none;">
    <!-- Las preguntas se cargar√°n din√°micamente aqu√≠ -->
  </main>

  <!-- Resultado final -->
  <div id="resultado-final" class="resultado-final">
    <h2>¬°Prueba Completada!</h2>
    <div class="puntaje" id="puntaje-display">0%</div>
    <p id="mensaje-resultado"></p>
    <p>Respuestas correctas: <strong id="correctas-display">0</strong> de <strong id="total-display">6</strong></p>
    <a href="/Resul?user_id={{ user_id }}&grado={{ grado }}">
      <button class="boton_siguiente">Ver Todos los Resultados</button>
    </a>
    <br><br>
    <a href="{{ url_for('competencias') }}?user_id={{ user_id }}&grado={{ grado }}">
      <button class="boton_siguiente">Volver a Competencias</button>
    </a>
  </div>

  <!-- Botones de navegaci√≥n -->
  <div id="botones-navegacion" class="botones" style="display: none;">
    <button id="btn-anterior" class="boton_volver">‚Üê Anterior</button>
    <button id="btn-siguiente" class="boton_siguiente">Siguiente ‚Üí</button>
    <button id="btn-finalizar" class="boton_finalizar" style="display: none;">‚úì Finalizar Prueba</button>
  </div>

  <script>
    // Variables globales
    const materia = '{{ materia }}';
    const grado = '{{ grado }}';
    const userId = {{ user_id if user_id else 'null' }};
    
    let currentOffset = 0;
    let totalPreguntas = 6;
    let todasLasRespuestas = {};
    let preguntasActuales = [];
    
    // Cargar preguntas al inicio
    document.addEventListener('DOMContentLoaded', () => {
      if (!userId || !grado) {
        alert('Error: No se ha iniciado sesi√≥n correctamente');
        window.location.href = '/';
        return;
      }
      cargarPreguntas(0);
    });
    
    // Funci√≥n para cargar preguntas desde la API
    async function cargarPreguntas(offset) {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('contenedor-preguntas').style.display = 'none';
        document.getElementById('botones-navegacion').style.display = 'none';
        document.getElementById('progreso').style.display = 'none';
        
        console.log(`üì° Cargando preguntas: materia=${materia}, grado=${grado}, offset=${offset}`);
        
        const response = await fetch(
          `/api/preguntas/${materia}?grado=${grado}&offset=${offset}&limit=2`
        );
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error en respuesta:', errorText);
          throw new Error('Error al cargar preguntas');
        }
        
        const data = await response.json();
        
        console.log('‚úÖ Datos recibidos:', data);
        
        if (!data.preguntas || data.preguntas.length === 0) {
          throw new Error('No hay preguntas disponibles para este grado y materia');
        }
        
        preguntasActuales = data.preguntas;
        totalPreguntas = data.total;
        currentOffset = offset;
        
        renderizarPreguntas(data.preguntas);
        actualizarBotones(data.has_more);
        actualizarProgreso();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('contenedor-preguntas').style.display = 'flex';
        document.getElementById('botones-navegacion').style.display = 'flex';
        document.getElementById('progreso').style.display = 'block';
        
        // Scroll al inicio
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        document.getElementById('loading').innerHTML = 
          `<p class="text-danger">Error: ${error.message}. Por favor, intenta de nuevo.</p>
           <a href="/competencias?user_id=${userId}&grado=${grado}">
             <button class="boton_volver" style="background-color: {{ color_materia }};">Volver a Competencias</button>
           </a>`;
      }
    }
    
    // Funci√≥n para actualizar el indicador de progreso
    function actualizarProgreso() {
      document.getElementById('progreso-actual').textContent = currentOffset + 1;
      const siguiente = Math.min(currentOffset + 2, totalPreguntas);
      document.getElementById('progreso-siguiente').textContent = siguiente;
      document.getElementById('progreso-total').textContent = totalPreguntas;
    }
    
    // Funci√≥n para renderizar preguntas en el DOM
    function renderizarPreguntas(preguntas) {
      const contenedor = document.getElementById('contenedor-preguntas');
      contenedor.innerHTML = '';
      
      preguntas.forEach((pregunta, index) => {
        const respuestaGuardada = todasLasRespuestas[pregunta.id];
        const respuestaObj = respuestaGuardada ? respuestaGuardada.respuesta : null;
        
        const divPregunta = document.createElement('div');
        divPregunta.className = 'pregunta-container';
        divPregunta.innerHTML = `
          <h2>Pregunta ${pregunta.numero}</h2>
          <p>${pregunta.enunciado}</p>
          ${pregunta.imagen ? `<img src="${pregunta.imagen}" alt="Imagen de pregunta">` : ''}
          
          <label class="${respuestaObj === 'A' ? 'selected' : ''}">
            <input type="radio" name="q${pregunta.id}" value="A" ${respuestaObj === 'A' ? 'checked' : ''}> 
            <span>A) ${pregunta.opcion_a}</span>
          </label>
          <label class="${respuestaObj === 'B' ? 'selected' : ''}">
            <input type="radio" name="q${pregunta.id}" value="B" ${respuestaObj === 'B' ? 'checked' : ''}> 
            <span>B) ${pregunta.opcion_b}</span>
          </label>
          <label class="${respuestaObj === 'C' ? 'selected' : ''}">
            <input type="radio" name="q${pregunta.id}" value="C" ${respuestaObj === 'C' ? 'checked' : ''}> 
            <span>C) ${pregunta.opcion_c}</span>
          </label>
          <label class="${respuestaObj === 'D' ? 'selected' : ''}">
            <input type="radio" name="q${pregunta.id}" value="D" ${respuestaObj === 'D' ? 'checked' : ''}> 
            <span>D) ${pregunta.opcion_d}</span>
          </label>
        `;
        
        contenedor.appendChild(divPregunta);
        
        // Agregar event listeners para guardar respuestas
        const radios = divPregunta.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            guardarRespuesta(pregunta.id, e.target.value, pregunta.respuesta_correcta);
            
            // Actualizar estilos visuales
            const labels = divPregunta.querySelectorAll('label');
            labels.forEach(l => l.classList.remove('selected'));
            e.target.parentElement.classList.add('selected');
          });
        });
      });
    }
    
    // Funci√≥n para guardar respuesta localmente
    function guardarRespuesta(preguntaId, respuesta, respuestaCorrecta) {
      todasLasRespuestas[preguntaId] = {
        respuesta: respuesta,
        correcta: respuesta === respuestaCorrecta
      };
      console.log('‚úÖ Respuesta guardada:', preguntaId, respuesta, 'Correcta:', respuesta === respuestaCorrecta);
    }
    
    // Actualizar estado de botones
    function actualizarBotones(hasMore) {
      const btnAnterior = document.getElementById('btn-anterior');
      const btnSiguiente = document.getElementById('btn-siguiente');
      const btnFinalizar = document.getElementById('btn-finalizar');
      
      btnAnterior.disabled = currentOffset === 0;
      btnAnterior.style.display = currentOffset === 0 ? 'none' : 'inline-block';
      
      if (hasMore) {
        btnSiguiente.style.display = 'inline-block';
        btnFinalizar.style.display = 'none';
      } else {
        btnSiguiente.style.display = 'none';
        btnFinalizar.style.display = 'inline-block';
      }
    }
    
    // Event listeners para botones
    document.getElementById('btn-anterior').addEventListener('click', () => {
      if (currentOffset >= 2) {
        cargarPreguntas(currentOffset - 2);
      }
    });
    
    document.getElementById('btn-siguiente').addEventListener('click', () => {
      cargarPreguntas(currentOffset + 2);
    });
    
    document.getElementById('btn-finalizar').addEventListener('click', async () => {
      const respondidas = Object.keys(todasLasRespuestas).length;
      
      if (respondidas < totalPreguntas) {
        const confirmar = confirm(
          `Has respondido ${respondidas} de ${totalPreguntas} preguntas.\n\n` +
          `Las preguntas sin responder se contar√°n como incorrectas.\n\n` +
          `¬øDeseas finalizar de todas formas?`
        );
        
        if (!confirmar) {
          return;
        }
      }
      
      await finalizarPrueba();
    });
    
    // Funci√≥n para finalizar la prueba
    async function finalizarPrueba() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('contenedor-preguntas').style.display = 'none';
        document.getElementById('botones-navegacion').style.display = 'none';
        document.getElementById('progreso').style.display = 'none';
        
        // Preparar datos para enviar
        const respuestasArray = Object.entries(todasLasRespuestas).map(([id, data]) => ({
          pregunta_id: parseInt(id),
          respuesta: data.respuesta,
          correcta: data.correcta
        }));
        
        console.log('üì§ Enviando respuestas:', respuestasArray);
        
        const response = await fetch('/api/guardar-respuestas', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: userId,
            materia: materia,
            respuestas: respuestasArray
          })
        });
        
        if (!response.ok) {
          throw new Error('Error al guardar respuestas');
        }
        
        const resultado = await response.json();
        
        console.log('‚úÖ Resultado guardado:', resultado);
        
        // Mostrar resultado
        document.getElementById('loading').style.display = 'none';
        document.getElementById('resultado-final').style.display = 'block';
        document.getElementById('puntaje-display').textContent = `${resultado.puntaje}%`;
        document.getElementById('correctas-display').textContent = resultado.correctas;
        document.getElementById('total-display').textContent = resultado.total;
        
        let mensaje = '';
        if (resultado.puntaje >= 90) {
          mensaje = 'üéâ ¬°Excelente! Tienes un dominio sobresaliente de esta materia.';
        } else if (resultado.puntaje >= 70) {
          mensaje = 'üëç ¬°Muy bien! Tienes un buen conocimiento de la materia.';
        } else if (resultado.puntaje >= 50) {
          mensaje = 'üëå ¬°Buen trabajo! Sigue practicando para mejorar.';
        } else {
          mensaje = 'üìö Sigue estudiando. La pr√°ctica te ayudar√° a mejorar.';
        }
        
        document.getElementById('mensaje-resultado').textContent = mensaje;
        
        // Scroll al resultado
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Hubo un error al finalizar la prueba. Por favor, intenta de nuevo.');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('contenedor-preguntas').style.display = 'flex';
        document.getElementById('botones-navegacion').style.display = 'flex';
        document.getElementById('progreso').style.display = 'block';
      }
    }
  </script>
</body>

</html>